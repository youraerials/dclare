/**
 * dclare 0.1, april, 2013
 * @author Aubrey Anderson
 * MIT LICENSE
 */
var DclareApplication=function(){this.binder=new DclareDOMBinder(this);this.views={};this.visibleViewKeys="";this.attributeBase="data-d";this.transitionEnd=PrefixFree.prefixProperty("transitionEnd",true);this.animationEnd=PrefixFree.prefixProperty("animationEnd",true);if(this.animationEnd.indexOf("oz")>-1){this.animationEnd="animationend";this.transitionEnd="transitionend";}
else{this.animationEnd=this.animationEnd.charAt(0).toLowerCase()+this.animationEnd.slice(1);this.transitionEnd=this.transitionEnd.charAt(0).toLowerCase()+this.transitionEnd.slice(1);}};DclareApplication.prototype.start=function(inContainer){var _self=this;if(inContainer){if(typeof(inContainer)=="string"){this.domContainer=document.querySelector(inContainer);}
else{this.domContainer=inContainer;}}
else{if(document.querySelector(".dclare-container")){this.domContainer=document.querySelector(".dclare-container");}
else{this.domContainer=document.querySelector("body");}}
if(window.location.hash.length){var visibleViewKeys=window.location.hash.slice(1).split(",");$(visibleViewKeys).each(function(){_self.addView(this,true);});}
else{this.binder.walk();}
if(jQuery.migrateWarnings.length){console.warn("we saw some jq migration warnings:");console.warn(jQuery.migrateWarnings);}};DclareApplication.prototype.addView=function(inViewKey,inShouldAnimateIn,inContainer,inShouldReplaceContainer,inCallback){var _self=this;var delegateName=inViewKey.charAt(0).toUpperCase()+inViewKey.slice(1)+"View";var viewDelegate=null;if(window[delegateName]){viewDelegate=new window[delegateName]();}
else{console.warn(inViewKey+" has no associated view delagate, do you want to add a script tag?");console.warn("you'll need to create the "+delegateName+" view in the \"views\" folder and add the following");console.warn("to your page's HEAD tag");console.warn('<script src="views/'+inViewKey+'/delegate.js"></script>');console.warn('Here is some sample delegate code to get you going, paste this into views/'+inViewKey+'/delegate.js:');console.warn(delegateName+' = function() {\n  this.key = "'+inViewKey+'";\n};\n\n'+delegateName+'.prototype.onVisible = function() {\n  //console.log("'+inViewKey+' view on before visible called!");\n};');}
var newView=new DclareView(inViewKey,viewDelegate,this);if(inShouldReplaceContainer&&inContainer){newView.key=$(inContainer).attr("id");this.views[$(inContainer).attr("id")]=newView;}
else{this.views[inViewKey]=newView;}
DcUtil.loadCSS("views/"+inViewKey+"/style.css",function(){$.get("views/"+inViewKey+"/view.html",function(data){if(data.indexOf("<")>0){data=data.substring(data.indexOf("<"),data.length);console.warn("HEY! removing content before the first tag in view: "+inViewKey);}
newView.domContainer=$(data);newView.domContainer.addClass("dc-invisible");var region="default";if(newView.domContainer.attr("data-d-localize")){var localStr=dApplication.localStrings[region];$(newView.domContainer.find("[data-d-localize-key]")).each(function(){var key=$(this).attr("data-d-localize-key");var localVal=localStr[key];$(this).append(localVal);});}
if(newView.delegate)newView.delegate.domContainer=newView.domContainer;if(inContainer&&inShouldReplaceContainer){var containerID=$(inContainer).attr("id");newView.domContainer.attr("id",containerID);$(inContainer).replaceWith(newView.domContainer);var scopedQueryForView="#"+containerID;}
else if(inContainer){$(inContainer).append(newView.domContainer);}
else{$(_self.domContainer).append(newView.domContainer);}
_self.binder.walk(newView.key);newView.onDOMReady();if(inShouldAnimateIn){newView.show();}
if(inCallback){inCallback(newView);}});});};DclareApplication.prototype.removeView=function(inView)
{this.views[inView.key]=null;inView.destroy();};DclareApplication.prototype.getView=function(inViewKey){if(this.views[inViewKey]){return this.views[inViewKey];}
else{console.error(inViewKey+" not found! did you reference a specific id?");}};DclareApplication.prototype.showView=function(inActionObject)
{if(this.views[inActionObject.key]){this.views[inActionObject.key].show(inActionObject.params);}
else{this.addView(inActionObject.key,true);}};var DclareView=function(inViewKey,inViewDelegate,inDApplication){if(inViewDelegate){this.delegate=inViewDelegate;this.delegate.controller=this;}
this.key=inViewKey||"un-keyed-view";this.isVisible=false;this.canAnimate=true;this.application=inDApplication;if(this.delegate&&this.delegate.onCreate)this.delegate.onCreate();};DclareView.prototype.onDOMReady=function(){if(this.delegate&&this.delegate.onDOMReady)this.delegate.onDOMReady();};DclareView.prototype.onBeforeVisible=function(){if(this.delegate&&this.delegate.onBeforeVisible)this.delegate.onBeforeVisible();};DclareView.prototype.onVisible=function(){this.isVisible=true;if(this.delegate&&this.delegate.onVisible)this.delegate.onVisible();};DclareView.prototype.onBeforeInvisible=function(){if(this.delegate&&this.delegate.onBeforeInvisible)this.delegate.onBeforeInvisible();};DclareView.prototype.onInvisible=function(){this.isVisible=false;if(this.delegate&&this.delegate.onInvisible)this.delegate.onInvisible();};DclareView.prototype.show=function(inViewParams,inPreserveViewInURL){var _self=this;if(this.canAnimate){this.canAnimate=false;if(inViewParams&&this.delegate){this.delegate.params=inViewParams;}
_self.onBeforeVisible();_self.domContainer.unbind(_self.application.animationEnd);this.domContainer.bind(_self.application.animationEnd,function(inEvent){if(inEvent.target===_self.domContainer.get(0)){_self.domContainer.unbind(_self.application.animationEnd);_self.domContainer.addClass("dc-visible");_self.domContainer.removeClass("dc-animate-in");_self.canAnimate=true;_self.onVisible();}});this.domContainer.addClass("dc-animate-in");this.domContainer.removeClass("dc-invisible");if(inPreserveViewInURL){if(window.location.hash.length){var visibleViewKeys=window.location.hash.slice(1).split(",");var okToAdd=true;for(var i=0;i<visibleViewKeys.length;i++){if(this.key==visibleViewKeys[i]){okToAdd=false;break;}}
if(okToAdd){visibleViewKeys.push(this.key);}}
else{visibleViewKeys=[this.key];}
window.location.hash=visibleViewKeys.toString();}}
else{}};DclareView.prototype.hide=function(inViewParams){var _self=this;if(this.canAnimate){this.canAnimate=false;if(inViewParams){this.delegate.params=inViewParams;}
_self.onBeforeInvisible();_self.domContainer.unbind(_self.application.animationEnd);this.domContainer.bind(_self.application.animationEnd,function(inEvent){if(inEvent.target===_self.domContainer.get(0)){_self.domContainer.addClass("dc-invisible");_self.domContainer.removeClass("dc-animate-out");_self.canAnimate=true;_self.onInvisible();_self.domContainer.unbind(_self.application.animationEnd);}});this.domContainer.addClass("dc-animate-out");this.domContainer.removeClass("dc-visible");}
else{}};DclareView.prototype.callFunction=function(inFunctionName,inArgs,inEvent){if(this.delegate){this.delegate[inFunctionName](inEvent,inArgs);}};DclareView.prototype.onBeforeDestroy=function(){if(this.delegate&&this.delegate.onBeforeDestroy){this.delegate.onBeforeDestroy();}};DclareView.prototype.destroy=function(){this.onBeforeDestroy();$(this.domContainer).remove();};var DclareDOMBinder=function(inDApplication){var _self=this;var _dAppReference=inDApplication;this.walk=function(inViewKey){if(inViewKey){this.currentView=inViewKey;}
else{this.currentView=false;}
var queryScope="["+_dAppReference.attributeBase+"]:not(.dc-bound)";var selections=document.querySelectorAll(queryScope);for(var q=selections.length-1;q>-1;q--){var domObject=selections[q];$(domObject).addClass("dc-bound");var att=$(domObject).attr("data-d");if(att){_self.processAttribute(att,domObject);}
else{console.error("something bad happened with your data-d attribute!");console.error("we selected an element which had it, and now that element doesn't have it.  here it is: ");console.error(domObject)}}};this.processAttribute=function(inAttributeString,inDOMObject){var commandStrings=inAttributeString.split(";");for(var i=0;i<commandStrings.length;i++){var commandString=commandStrings[i].split(":");if(commandString.length&&commandString.length>1){var bindingString=commandString[0];var actionString=commandString[1];var actionObject=this.processAction(actionString,inDOMObject);this.processDclareDirective(bindingString,actionObject,inDOMObject,this.currentView);}
else{this.throwError(inAttributeString,inDOMObject);}}};this.processDclareDirective=function(inDirectiveString,inActionObject,inDOMObject,inView){var _self=this;if(inDirectiveString.length>1){var eventString="click";var castStart=inDirectiveString.indexOf("(")+1;var castEnd=inDirectiveString.indexOf(")");var action=inDirectiveString;if(castStart>-1&&castEnd>-1){eventString=inDirectiveString.substring(castStart,castEnd);action=inDirectiveString.slice(castEnd+1);}
inActionObject.action=DcUtil.stripWhiteSpace(action);if(inActionObject.action.toLowerCase()=="view"){if(inActionObject.params&&inActionObject.params[0]=="animate"){_dAppReference.addView(inActionObject.key,true,inDOMObject,true);}
else{_dAppReference.addView(inActionObject.key,false,inDOMObject,true);}}
else{if(DcUtil.isTouch()){}
else{if(eventString=="touchstart"){eventString="mousedown";}}
$(inDOMObject).bind(eventString,function(inEvent){inEvent.preventDefault();inEvent.stopPropagation();_self.handleBoundAction(inEvent,inActionObject,inDOMObject,inView);});}}
else{this.throwError(inDirectiveString,inDOMObject);}};this.processAction=function(inActionString,inDOMObject){if(inActionString.length>1){var keyVals=inActionString.split("/");if(keyVals.length>1){keyVals[1]=keyVals[1].split(",");for(var i=0;i<keyVals[1].length;i++){keyVals[1][i]=DcUtil.stripWhiteSpace(keyVals[1][i]);}}
var ret={key:DcUtil.stripWhiteSpace(keyVals[0]),params:keyVals[1]};return(ret);}
else{this.throwError(inActionString,inDOMObject);return({key:"none",params:[]});}};this.handleBoundAction=function(inEvent,inActionObject,inOriginalDOMObject,inViewKey){if(inActionObject.action.toLowerCase()=="call"){if(inViewKey){_dAppReference.views[inViewKey].callFunction(inActionObject.key,inActionObject.params,inEvent);}
else{if(typeof(_dAppReference[inActionObject.key])=="function")
{_dAppReference[inActionObject.key](inActionObject.params,inEvent);}
else
{console.warn("exhausted tree looking for a function called "+inActionObject.key);}}}
else if(inActionObject.action.toLowerCase()=="addclass"){var selector=inActionObject.params+"";$(selector).addClass(inActionObject.key);}
else if(inActionObject.action.toLowerCase()=="removeclass"){var selector=inActionObject.params+"";$(selector).removeClass(inActionObject.key);}
else if(inActionObject.action.toLowerCase()=="toggleclass"){var selector=inActionObject.params+"";$(selector).toggleClass(inActionObject.key);}
else if(inActionObject.action.toLowerCase()=="emit"){var viewsToEmit=1;var maxEmitterViews=0;var container=false;if(inActionObject.params[0]){if(inActionObject.params[0].indexOf("-")>-1){var emitRange=inActionObject.params[0].split("-");viewsToEmit=parseInt(emitRange[0]);maxEmitterViews=parseInt(emitRange[1]);}
else{viewsToEmit=parseInt(inActionObject.params[0]);}}
if(inActionObject.params[2]){if(inActionObject.params[2]=="target"){container=inEvent.target;}
else{container=document.querySelector(inActionObject.params[2]);}}
else{container=document.querySelector(".dclare-container");}
for(var i=0;i<viewsToEmit;i++){if(maxEmitterViews){if(inActionObject.params[3]){var totalCurrentViews=document.querySelectorAll(inActionObject.params[3]);}
else{var totalCurrentViews=document.querySelectorAll("."+inActionObject.key);}
if(totalCurrentViews.length&&totalCurrentViews.length>maxEmitterViews){var dif=totalCurrentViews.length-maxEmitterViews;for(var x=0;x<dif;x++){totalCurrentViews[x].parentNode.removeChild(totalCurrentViews[x]);}}}
_dAppReference.addView(inActionObject.key,false,container,false,function(inView){if(inActionObject.params[1]){if(inActionObject.params[1]=="event"){if(DcUtil.isTouch()){var containerX=$(container).position().left;var containerY=$(container).position().top;var x=inEvent.originalEvent.touches[0].pageX-containerX;var y=inEvent.originalEvent.touches[0].pageY-containerY;}
else{var containerX=$(container).position().left;var containerY=$(container).position().top;var x=inEvent.pageX-containerX;var y=inEvent.pageY-containerY;}
$(inView.domContainer).css({left:x,top:y});inView.show();}}});}}
else if(inActionObject.action.toLowerCase()=="showview"){_dAppReference.showView(inActionObject);}
else if(inActionObject.action.toLowerCase()=="hideview"){if(_dAppReference.views[inActionObject.key]){_dAppReference.views[inActionObject.key].hide(inActionObject.params);}
else{this.throwError(inActionObject.key+" view not found, can't hide! did you maybe not specify the view key as the element ID?");}}
else if(inActionObject.action.toLowerCase()=="toggleview"){if(_dAppReference.views[inActionObject.key]){if(_dAppReference.views[inActionObject.key].isVisible){_dAppReference.views[inActionObject.key].hide(inActionObject.params);}
else{_dAppReference.views[inActionObject.key].show(inActionObject.params);}}
else{_dAppReference.addView(inActionObject.key,true);}}};this.throwError=function(inErrorString,inDOMObject){console.warn("ERROR, Skipped DClare string was:");console.warn(inErrorString);if(inDOMObject)console.warn(inDOMObject);};};var DcUtil={stripWhiteSpace:function(inString){return jQuery.trim(inString);},isTouch:function(){return!!('ontouchstart'in window)||!!('onmsgesturechange'in window);},cssCache:[],loadCSS:function(url,callback){if(DcUtil.cssCache.indexOf(url)<0){var link=document.createElement('link');link.type='text/css';link.rel='stylesheet';link.href=url;document.getElementsByTagName('head')[0].appendChild(link);DcUtil.cssCache.push(url);var img=document.createElement('img');img.onerror=function(){if(callback)callback();}
img.src=url;}
else{if(callback)callback();}}};